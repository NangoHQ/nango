name: '[Release] Build self-hosted'
on:
    push:
        branches:
            - master
            - staging/**
    pull_request:
    merge_group:

concurrency:
    group: pulls/${{ github.event.pull_request.number || github.ref }}
    cancel-in-progress: true

jobs:
    push-container:
        if: github.ref == 'refs/heads/master'
        runs-on: ubuntu-latest
        env:
            CAN_PUSH: ${{ secrets.DOCKER_PASSWORD != '' && secrets.DOCKER_USERNAME != '' }}
        steps:
            - uses: actions/checkout@v4
            - uses: docker/setup-buildx-action@v3
            - uses: actions/setup-node@v4
              with:
                  cache: 'npm'
                  node-version-file: '.nvmrc'

            - uses: docker/login-action@v3
              if: env.CAN_PUSH == 'true'
              with:
                  username: ${{ secrets.DOCKER_USERNAME }}
                  password: ${{ secrets.DOCKER_PASSWORD }}

            - name: Build and push container
              env:
                  PUSH: ${{ (env.CAN_PUSH == 'true') && '--push' || '' }}
              run: |
                  echo "Building"
                  echo "Tags: ${{ inputs.tags }}"
                  VERSION=${node -p "require('./package.json').version"}

                  docker buildx build -f Dockerfile.self_hosted --platform linux/amd64 -t nangohq/nango-server:hosted -t nangohq/nango-server:hosted-${{ github.event.pull_request.head.sha || github.sha }} -t nangohq/nango-server:hosted-${VERSION} . ${{ env.PUSH }}
